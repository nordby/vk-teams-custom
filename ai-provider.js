// VK Teams Custom Reactions - Universal AI Provider
// Supports: OpenAI, Claude, Gemini, Ollama, Custom endpoints

(function() {
    'use strict';

    // === Base AI Provider Interface ===
    class AIProvider {
        constructor(config) {
            this.config = config;
            this.apiKey = config.apiKey;
            this.model = config.model;
            this.temperature = config.temperature || 0.7;
            this.maxTokens = config.maxTokens || 500;
        }

        async generateResponse(prompt, context = '') {
            // Send request to background script to bypass CORS
            console.log('[VK Teams AI] Sending request to background script:', this.config.provider);
            return new Promise((resolve, reject) => {
                chrome.runtime.sendMessage({
                    action: 'aiRequest',
                    provider: this.config.provider,
                    config: this.config,
                    prompt: prompt,
                    context: context
                }, (response) => {
                    console.log('[VK Teams AI] Response from background:', response);
                    if (chrome.runtime.lastError) {
                        console.error('[VK Teams AI] Runtime error:', chrome.runtime.lastError);
                        reject(new Error(chrome.runtime.lastError.message));
                    } else if (!response) {
                        console.error('[VK Teams AI] No response from background script');
                        reject(new Error('No response from background script'));
                    } else if (response.success) {
                        resolve(response.result);
                    } else {
                        reject(new Error(response.error));
                    }
                });
            });
        }
    }

    // === Simplified Providers (all use base class) ===
    class OpenAIProvider extends AIProvider {}
    class ClaudeProvider extends AIProvider {}
    class GeminiProvider extends AIProvider {}
    class OllamaProvider extends AIProvider {}
    class CustomProvider extends AIProvider {}

    // === AI Manager ===
    class AIManager {
        constructor() {
            this.provider = null;
            this.config = null;
        }

        async init() {
            // Load AI config from storage
            return new Promise((resolve) => {
                chrome.storage.sync.get(['aiConfig'], (result) => {
                    if (result.aiConfig) {
                        this.config = result.aiConfig;
                        this.provider = this.createProvider(this.config);
                        console.log('[VK Teams AI] AI Provider initialized:', this.config.provider);
                    } else {
                        console.log('[VK Teams AI] No AI config found');
                    }
                    resolve();
                });
            });
        }

        createProvider(config) {
            switch (config.provider) {
                case 'openai':
                    return new OpenAIProvider(config);
                case 'claude':
                    return new ClaudeProvider(config);
                case 'gemini':
                    return new GeminiProvider(config);
                case 'ollama':
                    return new OllamaProvider(config);
                case 'custom':
                    return new CustomProvider(config);
                default:
                    throw new Error(`Unknown provider: ${config.provider}`);
            }
        }

        isConfigured() {
            return this.provider !== null && this.config !== null;
        }

        async generateSmartReply(messageText) {
            if (!this.isConfigured()) {
                throw new Error('AI not configured');
            }

            const prompt = `–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–º–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–ª–ª–µ–≥–∏.

–ö–û–ù–¢–ï–ö–°–¢:
- –≠—Ç–æ —Ä–∞–±–æ—á–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –≤ VK Teams
- –ù—É–∂–µ–Ω –∫—Ä–∞—Ç–∫–∏–π, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
- –¢–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π)

–ü–†–ê–í–ò–õ–ê:
1. –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å - –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
2. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—å–±–∞/–∑–∞–¥–∞—á–∞ - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å
3. –ï—Å–ª–∏ —ç—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –∏–ª–∏ –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —É–º–µ—Å—Ç–Ω–æ
4. –ï—Å–ª–∏ —ç—Ç–æ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ - –≤—ã—Å–∫–∞–∂–∏ –º–Ω–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ
5. –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–Ω–µ –±–æ–ª–µ–µ 2 —Å—Ç—Ä–æ–∫)
6. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω
7. –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞. –ù–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –º–µ—Ç–æ–∫, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

–°–û–û–ë–©–ï–ù–ò–ï –û–¢ –ö–û–õ–õ–ï–ì–ò:
"${messageText}"

–¢–í–û–ô –û–¢–í–ï–¢:`;
            return await this.provider.generateResponse(prompt);
        }

        async summarizeMessage(messageText) {
            if (!this.isConfigured()) {
                throw new Error('AI not configured');
            }

            const prompt = `–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

–ö–û–ù–¢–ï–ö–°–¢:
- –≠—Ç–æ —Ä–∞–±–æ—á–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –≤ VK Teams
- –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å: –∑–∞–¥–∞—á–∏, –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –≤–æ–ø—Ä–æ—Å—ã
- –ò–∑–ª–æ–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—É—Ç–∏ –±–µ–∑ —á—Ç–µ–Ω–∏—è –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞

–ü–†–ê–í–ò–õ–ê –°–û–ó–î–ê–ù–ò–Ø –ò–ó–õ–û–ñ–ï–ù–ò–Ø:
1. –í—ã–¥–µ–ª–∏ –ì–õ–ê–í–ù–£–Æ –º—ã—Å–ª—å (—á—Ç–æ —Ö–æ—á–µ—Ç —Å–∫–∞–∑–∞—Ç—å –∞–≤—Ç–æ—Ä)
2. –ü–µ—Ä–µ—á–∏—Å–ª–∏ –ö–õ–Æ–ß–ï–í–´–ï –ø—É–Ω–∫—Ç—ã (–∑–∞–¥–∞—á–∏, –≤–æ–ø—Ä–æ—Å—ã, —Ä–µ—à–µ–Ω–∏—è)
3. –°–æ—Ö—Ä–∞–Ω–∏ –í–ê–ñ–ù–´–ï –¥–µ—Ç–∞–ª–∏ (—Å—Ä–æ–∫–∏, –∏–º–µ–Ω–∞, —Ü–∏—Ñ—Ä—ã)
4. –£–±–µ—Ä–∏ –≤–æ–¥—É, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã
5. –î–ª–∏–Ω–∞: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
6. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–µ—Å–ª–∏ –ø—É–Ω–∫—Ç–æ–≤ –º–Ω–æ–≥–æ - –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–µ—Ä—ã)
7. –°–æ—Ö—Ä–∞–Ω–∏ —Ç–æ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (—Å—Ä–æ—á–Ω–æ—Å—Ç—å, –≤–∞–∂–Ω–æ—Å—Ç—å)

–¢–ò–ü–´ –°–û–û–ë–©–ï–ù–ò–ô:
- –ó–∞–¥–∞—á–∞: –ö—Ç–æ, —á—Ç–æ, –∫–æ–≥–¥–∞, –∑–∞—á–µ–º
- –í–æ–ø—Ä–æ—Å: –°—É—Ç—å –≤–æ–ø—Ä–æ—Å–∞ + –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç + –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
- –û–±—Å—É–∂–¥–µ–Ω–∏–µ: –¢–µ–º–∞ + –∫–ª—é—á–µ–≤—ã–µ –º–Ω–µ–Ω–∏—è

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü–∏—à–∏ –¢–û–õ–¨–ö–û –∫—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ. –ë–µ–∑ –ø—Ä–µ–∞–º–±—É–ª —Ç–∏–ø–∞ "–í —ç—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏..." –∏–ª–∏ "–ê–≤—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç...".

–ò–°–•–û–î–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï:
"${messageText}"

–ö–†–ê–¢–ö–û–ï –ò–ó–õ–û–ñ–ï–ù–ò–ï:`;
            return await this.provider.generateResponse(prompt);
        }

        async translateMessage(messageText) {
            if (!this.isConfigured()) {
                throw new Error('AI not configured');
            }

            // Auto-detect language by counting Cyrillic vs Latin characters
            const cyrillicCount = (messageText.match(/[–∞-—è–ê-–Ø—ë–Å]/g) || []).length;
            const latinCount = (messageText.match(/[a-zA-Z]/g) || []).length;

            // If more Cyrillic characters than Latin, it's Russian
            // Otherwise it's English (or treat as English if equal/no letters)
            const isRussian = cyrillicCount > latinCount;

            let prompt;
            if (isRussian) {
                // Russian to English
                prompt = `You are a professional translator for corporate communications. Translate Russian business text to English.

CONTEXT:
- This is from a VK Teams corporate messenger
- May contain: technical terms, tasks, questions, discussions
- Translation should sound natural in English

TRANSLATION RULES:
1. Preserve the MEANING and TONE (formal/informal, urgent/casual)
2. Keep technical terms in original if commonly used (API, backend, deploy, etc.)
3. Adapt idioms and expressions to English equivalents
4. Maintain formatting (line breaks, lists, emphasis)
5. Keep names, dates, numbers unchanged
6. Professional but natural style

EXAMPLES OF GOOD TRANSLATIONS:
- "–ù—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–æ—Ñ–∏–∫—Å–∏—Ç—å" ‚Üí "Need to fix this urgently"
- "–î–∞–≤–∞–π —Å–æ–∑–≤–æ–Ω–∏–º—Å—è" ‚Üí "Let's hop on a call"
- "–û—Ç–ø—Ä–∞–≤–∏–ª PR –Ω–∞ —Ä–µ–≤—å—é" ‚Üí "Sent the PR for review"

OUTPUT FORMAT:
Write ONLY the translated text. No labels like "Translation:", no explanations.

RUSSIAN TEXT:
"${messageText}"

ENGLISH TRANSLATION:`;
            } else {
                // English to Russian
                prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ê–ù–ì–õ–ò–ô–°–ö–ò–ô —Ç–µ–∫—Å—Ç –Ω–∞ –†–£–°–°–ö–ò–ô —è–∑—ã–∫.

–í–ê–ñ–ù–û: –¢–µ–∫—Å—Ç –Ω–∏–∂–µ –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ –ê–ù–ì–õ–ò–ô–°–ö–û–ú —è–∑—ã–∫–µ. –¢—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –µ–≥–æ –Ω–∞ –†–£–°–°–ö–ò–ô. –ù–ï –æ—Å—Ç–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º!

–ö–û–ù–¢–ï–ö–°–¢:
- –≠—Ç–æ –∏–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ VK Teams
- –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã, –∑–∞–¥–∞—á–∏, –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Å—É–∂–¥–µ–Ω–∏—è
- –ü–µ—Ä–µ–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –∑–≤—É—á–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–ü–†–ê–í–ò–õ–ê –ü–ï–†–ï–í–û–î–ê:
1. –ü–µ—Ä–µ–≤–µ–¥–∏ –í–ï–°–¨ —Ç–µ–∫—Å—Ç –Ω–∞ –†–£–°–°–ö–ò–ô —è–∑—ã–∫
2. –°–æ—Ö—Ä–∞–Ω–∏ –°–ú–´–°–õ –∏ –¢–û–ù (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, —Å—Ä–æ—á–Ω—ã–π/–æ–±—ã—á–Ω—ã–π)
3. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –º–æ–∂–µ—à—å –æ—Å—Ç–∞–≤–ª—è—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –µ—Å–ª–∏ –æ–Ω–∏ –æ–±—â–µ—É–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å–Ω—ã–µ (API, –±—ç–∫–µ–Ω–¥, –¥–µ–ø–ª–æ–π, –∫–æ–º–º–∏—Ç, –∏ —Ç.–¥.)
4. –ê–¥–∞–ø—Ç–∏—Ä—É–π –∏–¥–∏–æ–º—ã –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∫ —Ä—É—Å—Å–∫–∏–º —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞–º
5. –°–æ—Ö—Ä–∞–Ω–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, —Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è)
6. –ò–º–µ–Ω–∞, –¥–∞—Ç—ã, —Ü–∏—Ñ—Ä—ã –Ω–µ –∏–∑–º–µ–Ω—è–π
7. –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –ü–ï–†–ï–í–û–î–û–í (English ‚Üí –†—É—Å—Å–∫–∏–π):
- "Need to fix this urgently" ‚Üí "–ù—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –ø–æ—Ñ–∏–∫—Å–∏—Ç—å"
- "Let's hop on a call" ‚Üí "–î–∞–≤–∞–π —Å–æ–∑–≤–æ–Ω–∏–º—Å—è"
- "Sent the PR for review" ‚Üí "–û—Ç–ø—Ä–∞–≤–∏–ª PR –Ω–∞ —Ä–µ–≤—å—é"
- "The build is failing" ‚Üí "–°–±–æ—Ä–∫–∞ –ø–∞–¥–∞–µ—Ç"
- "Can you review my code?" ‚Üí "–ú–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–π –∫–æ–¥?"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï. –ë–µ–∑ –º–µ—Ç–æ–∫ —Ç–∏–ø–∞ "–ü–µ—Ä–µ–≤–æ–¥:", –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–ê–ù–ì–õ–ò–ô–°–ö–ò–ô –¢–ï–ö–°–¢ –î–õ–Ø –ü–ï–†–ï–í–û–î–ê –ù–ê –†–£–°–°–ö–ò–ô:
"${messageText}"

–†–£–°–°–ö–ò–ô –ü–ï–†–ï–í–û–î:`;
            }

            return await this.provider.generateResponse(prompt);
        }

        async changeTone(messageText, tone) {
            if (!this.isConfigured()) {
                throw new Error('AI not configured');
            }

            const toneGuides = {
                formal: {
                    desc: '–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π',
                    rules: `- –ò—Å–ø–æ–ª—å–∑—É–π –≤–µ–∂–ª–∏–≤—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è ("–£–≤–∞–∂–∞–µ–º—ã–µ –∫–æ–ª–ª–µ–≥–∏", "–ü—Ä–æ—à—É —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å")
- –ò–∑–±–µ–≥–∞–π —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π –∏ –∂–∞—Ä–≥–æ–Ω–∞
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –§–æ—Ä–º–∞–ª—å–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞ ("–æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—å", "–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å", "—Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å")`,
                    example: '"–ù—É–∂–Ω–æ –ø–æ—Ñ–∏–∫—Å–∏—Ç—å –±–∞–≥" ‚Üí "–ü—Ä–æ—à—É —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏"'
                },
                casual: {
                    desc: '–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π',
                    rules: `- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è (–æ–∫, –ª–∞–Ω, –Ω–æ—Ä–º)
- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞, –Ω–æ –±–µ–∑ –≥—Ä—É–±–æ—Å—Ç–∏`,
                    example: '"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤—Å—Ç—Ä–µ—á—É" ‚Üí "–î–∞–≤–∞–π —Å–æ–∑–≤–æ–Ω–∏–º—Å—è"'
                },
                friendly: {
                    desc: '–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —Ç—ë–ø–ª—ã–π',
                    rules: `- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–≤–µ—Ç–ª–∏–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è ("—Ä–∞–¥ –ø–æ–º–æ—á—å", "—Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º")
- –≠–º–æ–¥–∑–∏ —É–º–µ—Å—Ç–Ω—ã (–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞ - –º–∞–∫—Å 1-2)
- –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –ü—Ä–æ—è–≤–ª—è–π –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å`,
                    example: '"–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∑–∞–¥–∞—á–µ–π" ‚Üí "–° —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É —Å –∑–∞–¥–∞—á–µ–π! üòä"'
                }
            };

            const guide = toneGuides[tone];
            const prompt = `–¢—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–∏–≤ –µ–≥–æ —Ç–æ–Ω, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Å–º—ã—Å–ª.

–¶–ï–õ–ï–í–û–ô –¢–û–ù: ${guide.desc}

–ü–†–ê–í–ò–õ–ê –î–õ–Ø –≠–¢–û–ì–û –¢–û–ù–ê:
${guide.rules}

–ü–†–ò–ú–ï–† –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ò:
${guide.example}

–í–ê–ñ–ù–û:
- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–Æ –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–¥–∞—Ç—ã, –∏–º–µ–Ω–∞, –∑–∞–¥–∞—á–∏, –≤–æ–ø—Ä–æ—Å—ã)
- –ò–∑–º–µ–Ω–∏ –¢–û–õ–¨–ö–û —Å—Ç–∏–ª—å –ø–æ–¥–∞—á–∏
- –î–ª–∏–Ω–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è, –Ω–æ –Ω–µ —Å–∏–ª—å–Ω–æ (¬±30%)
- –°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –µ—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–∫–∏/–ø—É–Ω–∫—Ç—ã

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü–∏—à–∏ –¢–û–õ–¨–ö–û –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ –º–µ—Ç–æ–∫ "–ü–µ—Ä–µ–ø–∏—Å–∞–Ω–æ:" –∏ —Ç.–ø.

–ò–°–•–û–î–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï:
"${messageText}"

–°–û–û–ë–©–ï–ù–ò–ï –í –ù–û–í–û–ú –¢–û–ù–ï:`;
            return await this.provider.generateResponse(prompt);
        }

        async explainForManager(messageText) {
            if (!this.isConfigured()) {
                throw new Error('AI not configured');
            }

            const prompt = `–¢—ã –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –¥–µ–ª–æ–≤–æ–π —è–∑—ã–∫.

–ê–£–î–ò–¢–û–†–ò–Ø:
- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–≥—Ä–∞—É–Ω–¥–∞
- –ü–æ–Ω–∏–º–∞—é—Ç –±–∏–∑–Ω–µ—Å-—Ü–µ–ª–∏, –Ω–æ –Ω–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- –ò–º –≤–∞–∂–Ω–æ: –ß–¢–û –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –ó–ê–ß–ï–ú, –ö–û–ì–î–ê, –ö–ê–ö–ò–ï –†–ò–°–ö–ò

–ü–†–ê–í–ò–õ–ê –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ò:
1. –£–ë–ï–†–ò —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∂–∞—Ä–≥–æ–Ω –∏ –∑–∞–º–µ–Ω–∏ –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
2. –°–û–•–†–ê–ù–ò –±–∏–∑–Ω–µ—Å-—Ü–µ–Ω–Ω–æ—Å—Ç—å, —Å—Ä–æ–∫–∏, —Ä–∏—Å–∫–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
3. –û–ë–™–Ø–°–ù–ò "–∑–∞—á–µ–º" –∏ "–∫–∞–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç" –≤–º–µ—Å—Ç–æ "–∫–∞–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏"
4. –ò–°–ü–û–õ–¨–ó–£–ô –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
5. –°–¢–†–£–ö–¢–£–†–ò–†–£–ô: —Å–Ω–∞—á–∞–ª–∞ –≥–ª–∞–≤–Ω–æ–µ, –ø–æ—Ç–æ–º –¥–µ—Ç–∞–ª–∏
6. –î–õ–ò–ù–ê: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ü–†–ò–ú–ï–†–´ –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ô:
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ ‚Üí –ü—Ä–æ—Å—Ç–æ–µ:
- "–î–µ–ø–ª–æ–π —É–ø–∞–ª –∏–∑-–∑–∞ race condition –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–µ"
  ‚Üí "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ –ø—Ä–æ—à–ª–æ –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è 2 —á–∞—Å–∞"

- "–ù—É–∂–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å legacy –∫–æ–¥, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π"
  ‚Üí "–°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ç–æ—Ä–º–æ–∑–∏—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –ù—É–∂–Ω–∞ –Ω–µ–¥–µ–ª—è –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –±—É–¥—É—â–∏—Ö –∑–∞–¥–∞—á"

- "API rate limit –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
  ‚Üí "–í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

- "–ù–∞—Å—Ç—Ä–æ–∏–ª CI/CD pipeline —Å –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏"
  ‚Üí "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –≤—ã–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π. –≠—Ç–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç –≤—Ä–µ–º—è —Ä–µ–ª–∏–∑–æ–≤ –∏ —Å–Ω–∏–∑–∏—Ç –æ—à–∏–±–∫–∏"

–ß–¢–û –°–û–•–†–ê–ù–ò–¢–¨:
‚úì –°—Ä–æ–∫–∏ –∏ –¥–µ–¥–ª–∞–π–Ω—ã
‚úì –í–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úì –†–∏—Å–∫–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã
‚úì –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
‚úì –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏

–ß–¢–û –£–ë–†–ê–¢–¨:
‚úó –ù–∞–∑–≤–∞–Ω–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–µ—Å–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
‚úó –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
‚úó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
‚úó –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã (API, endpoint, deploy, –∏ —Ç.–¥.)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü–∏—à–∏ –¢–û–õ–¨–ö–û —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ. –ë–µ–∑ –ø—Ä–µ–∞–º–±—É–ª —Ç–∏–ø–∞ "–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ..." –∏–ª–∏ "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç...".
–°—Ä–∞–∑—É –ø–∏—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –°–û–û–ë–©–ï–ù–ò–ï:
"${messageText}"

–û–ë–™–Ø–°–ù–ï–ù–ò–ï –î–õ–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê:`;
            return await this.provider.generateResponse(prompt);
        }

        async customPrompt(messageText, userPrompt) {
            if (!this.isConfigured()) {
                throw new Error('AI not configured');
            }

            // Combine user's custom prompt with the message text
            const fullPrompt = `${userPrompt}\n\n–°–æ–æ–±—â–µ–Ω–∏–µ: "${messageText}"`;
            return await this.provider.generateResponse(fullPrompt);
        }
    }

    // Export to global scope for content.js
    window.VKTeamsAI = {
        AIManager: AIManager
    };

    console.log('[VK Teams AI] AI Provider module loaded');
})();
